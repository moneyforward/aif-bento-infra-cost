<!DOCTYPE html>
<html>
<head>
    <title>AWS Cost Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .cost-value {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
        }
        .chart-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-col {
            flex: 1;
            min-width: 0;
        }
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-left: 10px;
        }
        .service-details {
            margin-top: 20px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .table {
            margin-top: 15px;
        }
        .table th, .table td {
            padding: 12px;
        }
        .dashboard-layout {
            display: flex;
            gap: 20px;
        }
        
        .charts-section {
            flex: 1;
            min-width: 0;
        }
        
        .details-section {
            display: none;
        }
        
        .table {
            margin: 0;
        }
        
        .table td, .table th {
            padding: 8px;
            font-size: 0.9em;
        }
        .chart-container canvas {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>AWS Cost Analysis Dashboard For Model Inference(Approximately)</h1>
            <div>
                <label for="monthSelect">Select Month:</label>
                <select id="monthSelect" onchange="loadMonthData()">
                    <option value="feb-2025">February 2025</option>
                    <option value="jan-2025">January 2025</option>
                    <option value="dec-2024">December 2024</option>
                </select>
            </div>
        </div>
        
        <div class="summary-box">
            <h2>Cost Summary</h2>
            <div class="row">
                <div class="col-md-4">
                    <p>Total Cost</p>
                    <p class="cost-value">$<span id="total-cost">0</span></p>
                </div>
                <div class="col-md-4">
                    <p>Average Monthly Cost</p>
                    <p class="cost-value">$<span id="avg-monthly-cost">0</span></p>
                </div>
                <div class="col-md-4">
                    <p>Most Expensive Service</p>
                    <p class="cost-value"><span id="most-expensive-service">-</span></p>
                    <p>($<span id="most-expensive-cost">0</span>)</p>
                </div>
            </div>
        </div>

        <div class="dashboard-layout">
            <div class="charts-section">
                <div class="chart-row">
                    <div class="chart-col chart-container">
                        <canvas id="serviceChart"></canvas>
                    </div>
                    <div class="chart-col chart-container">
                        <canvas id="monthlyTrendChart"></canvas>
                        <div class="service-details" id="serviceDetails" style="display: none;">
                            <h3 id="serviceDetailsTitle">Service Details</h3>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="topResourcesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let serviceChart, monthlyTrendChart, resourcesChart;  // Global chart variables

        function loadMonthData() {
            const month = document.getElementById('monthSelect').value;
            fetch(`/api/costs/${month}`)
                .then(response => response.json())
                .then(updateDashboard);
        }

        function updateDashboard(data) {
            // Update summary
            document.getElementById('total-cost').textContent = data.summary.total_cost.toFixed(2);
            document.getElementById('avg-monthly-cost').textContent = data.summary.avg_monthly_cost.toFixed(2);
            document.getElementById('most-expensive-service').textContent = data.summary.most_expensive_service.name;
            document.getElementById('most-expensive-cost').textContent = data.summary.most_expensive_service.cost.toFixed(2);

            // Update charts
            updateServiceChart(data);
            updateMonthlyTrendChart(data);
            updateResourcesChart(data);
        }

        function updateServiceChart(data) {
            if (serviceChart) {
                serviceChart.destroy();
            }

            serviceChart = new Chart(document.getElementById('serviceChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(data.service_costs),
                    datasets: [{
                        data: Object.values(data.service_costs),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Cost Distribution by Service (${document.getElementById('monthSelect').value})`
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const selectedService = Object.keys(data.service_costs)[index];
                            updateMonthlyTrendForService(selectedService);
                            showServiceDetails(selectedService);
                        }
                    }
                }
            });
        }

        function updateMonthlyTrendForService(serviceName) {
            const month = document.getElementById('monthSelect').value;
            fetch(`/api/costs/${month}/${serviceName}`)
                .then(response => response.json())
                .then(data => {
                    if (monthlyTrendChart) {
                        monthlyTrendChart.destroy();
                    }

                    monthlyTrendChart = new Chart(document.getElementById('monthlyTrendChart'), {
                        type: 'bar',
                        data: {
                            labels: data.months,
                            datasets: [{
                                label: `${serviceName} Cost`,
                                data: data.costs,
                                backgroundColor: '#36A2EB',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${serviceName} Cost Trend (Last 3 Months)`
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Cost (USD)'
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function updateMonthlyTrendChart(data) {
            if (monthlyTrendChart) {
                monthlyTrendChart.destroy();
            }

            monthlyTrendChart = new Chart(document.getElementById('monthlyTrendChart'), {
                type: 'bar',
                data: {
                    labels: data.monthly_trend.months.map(m => {
                        const [month, year] = m.split('-');
                        return `${month.charAt(0).toUpperCase() + month.slice(1)} ${year}`;
                    }),
                    datasets: [{
                        label: 'Monthly Cost',
                        data: data.monthly_trend.costs,
                        backgroundColor: '#36A2EB',  // Back to single color
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Cost Trend (Last 3 Months)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cost: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost (USD)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        function updateResourcesChart(data) {
            if (resourcesChart) {
                resourcesChart.destroy();
            }

            resourcesChart = new Chart(document.getElementById('topResourcesChart'), {
                type: 'bar',
                data: {
                    labels: data.top_resources.map(r => `${r.service}: ${r.resource_name}`),
                    datasets: [{
                        label: 'Cost (USD)',
                        data: data.top_resources.map(r => r.cost_usd),
                        backgroundColor: '#4BC0C0'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Most Expensive Resources'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cost: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function showServiceDetails(serviceName) {
            const detailsDiv = document.getElementById('serviceDetails');
            detailsDiv.style.display = 'block';
            
            const month = document.getElementById('monthSelect').value;
            fetch(`/api/costs/${month}/${serviceName}/details`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('serviceDetailsTitle').textContent = `${serviceName} Details`;
                    
                    const table = detailsDiv.querySelector('table');
                    const thead = table.querySelector('thead');
                    const tbody = table.querySelector('tbody');
                    
                    // Clear existing content
                    thead.innerHTML = '';
                    tbody.innerHTML = '';
                    
                    // Add headers
                    const headerRow = document.createElement('tr');
                    data.columns.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col.label;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    
                    // Add data rows
                    data.resources.forEach(resource => {
                        const row = document.createElement('tr');
                        data.columns.forEach(col => {
                            const td = document.createElement('td');
                            const value = resource[col.key];
                            td.textContent = col.key === 'cost_usd' ? `$${value.toFixed(2)}` : 
                                           (col.key.includes('size') || col.key.includes('quantity')) ? 
                                           `${value.toFixed(2)}` : value;
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    });
                });
        }

        // Load initial data
        loadMonthData();
    </script>
</body>
</html> 